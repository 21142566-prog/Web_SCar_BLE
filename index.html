<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üöó ƒêi·ªÅu Khi·ªÉn Xe RC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 500px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1em;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connect-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
        }

        .connect-btn:active {
            transform: translateY(0);
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid white;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
        }

        .controls {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .d-pad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .control-btn {
            width: 100%;
            aspect-ratio: 1;
            border: none;
            border-radius: 15px;
            background: rgba(255,255,255,0.3);
            color: white;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.5);
        }

        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-up { grid-column: 2; grid-row: 1; }
        .btn-left { grid-column: 1; grid-row: 2; }
        .btn-stop { grid-column: 2; grid-row: 2; background: rgba(255,100,100,0.5); }
        .btn-right { grid-column: 3; grid-row: 2; }
        .btn-down { grid-column: 2; grid-row: 3; }

        .info {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .log {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid rgba(255,255,255,0.3);
            padding-left: 10px;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2em;
            }
            .control-btn {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Xe RC Bluetooth</h1>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Ch∆∞a k·∫øt n·ªëi</span>
            </div>
        </div>

        <button class="connect-btn" id="connectBtn" onclick="connectBLE()">
            üì° K·∫øt n·ªëi Bluetooth
        </button>

        <div class="mode-selector">
            <button class="mode-btn active" id="manualBtn" onclick="setMode('manual')">
                üéÆ Th·ªß c√¥ng
            </button>
            <button class="mode-btn" id="autoBtn" onclick="setMode('auto')">
                ü§ñ T·ª± ƒë·ªông
            </button>
        </div>

        <div class="controls">
            <div class="d-pad">
                <button class="control-btn btn-up" onpointerdown="sendCommand('F')" onpointerup="sendCommand('S')" disabled>
                    ‚¨ÜÔ∏è
                </button>
                <button class="control-btn btn-left" onpointerdown="sendCommand('L')" onpointerup="sendCommand('S')" disabled>
                    ‚¨ÖÔ∏è
                </button>
                <button class="control-btn btn-stop" onclick="sendCommand('S')" disabled>
                    üõë
                </button>
                <button class="control-btn btn-right" onpointerdown="sendCommand('R')" onpointerup="sendCommand('S')" disabled>
                    ‚û°Ô∏è
                </button>
                <button class="control-btn btn-down" onpointerdown="sendCommand('B')" onpointerup="sendCommand('S')" disabled>
                    ‚¨áÔ∏è
                </button>
            </div>
            
            <div class="info">
                Gi·ªØ n√∫t ƒë·ªÉ di chuy·ªÉn, th·∫£ ra ƒë·ªÉ d·ª´ng
            </div>
        </div>

        <div class="log" id="logContainer"></div>
    </div>

    <script>
        let bleDevice = null;
        let bleCharacteristic = null;
        let currentMode = 'manual';

        // UUID cho UART service (gi·ªëng code Pico c·ªßa b·∫°n)
        const UART_SERVICE_UUID = 0xFFE0;
        const UART_CHAR_UUID = 0xFFE1;

        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString('vi-VN');
            entry.textContent = `[${time}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Gi·ªØ t·ªëi ƒëa 10 d√≤ng log
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        async function connectBLE() {
            try {
                log('üîç ƒêang t√¨m ki·∫øm thi·∫øt b·ªã...');
                
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'PicoW' }],
                    optionalServices: [UART_SERVICE_UUID]
                });

                log('üì° ƒêang k·∫øt n·ªëi...');
                const server = await bleDevice.gatt.connect();
                
                log('üîé ƒêang t√¨m service...');
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                
                log('üìù ƒêang l·∫•y characteristic...');
                bleCharacteristic = await service.getCharacteristic(UART_CHAR_UUID);

                // X·ª≠ l√Ω khi m·∫•t k·∫øt n·ªëi
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                updateConnectionStatus(true);
                log('‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!');
                
                // G·ª≠i l·ªánh ch·∫ø ƒë·ªô th·ªß c√¥ng ban ƒë·∫ßu
                sendCommand('w');
                
            } catch (error) {
                log('‚ùå L·ªói: ' + error);
                updateConnectionStatus(false);
            }
        }

        function onDisconnected() {
            log('‚ùå M·∫•t k·∫øt n·ªëi!');
            updateConnectionStatus(false);
            bleCharacteristic = null;
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const controlBtns = document.querySelectorAll('.control-btn');
            const connectBtn = document.getElementById('connectBtn');

            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'ƒê√£ k·∫øt n·ªëi';
                connectBtn.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi';
                connectBtn.disabled = true;
                controlBtns.forEach(btn => btn.disabled = false);
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Ch∆∞a k·∫øt n·ªëi';
                connectBtn.textContent = 'üì° K·∫øt n·ªëi Bluetooth';
                connectBtn.disabled = false;
                controlBtns.forEach(btn => btn.disabled = true);
            }
        }

        async function sendCommand(cmd) {
            if (!bleCharacteristic) {
                log('‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi!');
                return;
            }

            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(cmd);
                await bleCharacteristic.writeValue(data);
                
                const cmdNames = {
                    'F': '‚¨ÜÔ∏è Ti·∫øn',
                    'B': '‚¨áÔ∏è L√πi',
                    'L': '‚¨ÖÔ∏è Tr√°i',
                    'R': '‚û°Ô∏è Ph·∫£i',
                    'S': 'üõë D·ª´ng',
                    'W': 'ü§ñ Auto',
                    'w': 'üéÆ Manual'
                };
                
                if (cmdNames[cmd]) {
                    log(cmdNames[cmd]);
                }
            } catch (error) {
                log('‚ùå L·ªói g·ª≠i l·ªánh: ' + error);
            }
        }

        function setMode(mode) {
            currentMode = mode;
            const manualBtn = document.getElementById('manualBtn');
            const autoBtn = document.getElementById('autoBtn');
            const controlBtns = document.querySelectorAll('.control-btn');

            if (mode === 'manual') {
                manualBtn.classList.add('active');
                autoBtn.classList.remove('active');
                controlBtns.forEach(btn => btn.disabled = !bleCharacteristic);
                sendCommand('w'); // G·ª≠i l·ªánh ch·∫ø ƒë·ªô manual
                log('üéÆ Chuy·ªÉn sang ch·∫ø ƒë·ªô Th·ªß c√¥ng');
            } else {
                manualBtn.classList.remove('active');
                autoBtn.classList.add('active');
                controlBtns.forEach(btn => btn.disabled = true);
                sendCommand('W'); // G·ª≠i l·ªánh ch·∫ø ƒë·ªô auto
                log('ü§ñ Chuy·ªÉn sang ch·∫ø ƒë·ªô T·ª± ƒë·ªông');
            }
        }

        // H·ªó tr·ª£ b√†n ph√≠m
        document.addEventListener('keydown', (e) => {
            if (!bleCharacteristic || currentMode !== 'manual') return;
            
            switch(e.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    sendCommand('F');
                    break;
                case 's':
                case 'arrowdown':
                    sendCommand('B');
                    break;
                case 'a':
                case 'arrowleft':
                    sendCommand('L');
                    break;
                case 'd':
                case 'arrowright':
                    sendCommand('R');
                    break;
                case ' ':
                    sendCommand('S');
                    break;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!bleCharacteristic || currentMode !== 'manual') return;
            
            if (['w', 's', 'a', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(e.key.toLowerCase())) {
                sendCommand('S');
            }
        });

        // Kh·ªüi t·∫°o
        log('üì± App ƒë√£ s·∫µn s√†ng!');
        log('üí° Nh·∫•n "K·∫øt n·ªëi Bluetooth" ƒë·ªÉ b·∫Øt ƒë·∫ßu');
    </script>
</body>
</html>
